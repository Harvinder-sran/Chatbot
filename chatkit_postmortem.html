<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatKit Integration - Debugging Postmortem</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #ffffff;
            padding: 60px;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-size: 42px;
            font-weight: 700;
            color: #10a37f;
            margin-bottom: 10px;
            border-bottom: 4px solid #10a37f;
            padding-bottom: 15px;
        }

        h2 {
            font-size: 28px;
            font-weight: 700;
            color: #2d2d2d;
            margin-top: 40px;
            margin-bottom: 15px;
            border-left: 5px solid #10a37f;
            padding-left: 15px;
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            color: #444;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        p,
        li {
            margin-bottom: 12px;
            font-size: 15px;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .summary-box p {
            margin: 8px 0;
            font-size: 16px;
        }

        .summary-box strong {
            font-weight: 700;
        }

        .problem-section {
            background: #f8f9fa;
            border-left: 5px solid #e74c3c;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .fix-section {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .lesson-section {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 13px;
            color: #e74c3c;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        pre code {
            background: transparent;
            color: #d4d4d4;
            padding: 0;
        }

        ul,
        ol {
            margin-left: 25px;
            margin-bottom: 20px;
        }

        .checklist {
            list-style: none;
            margin-left: 0;
        }

        .checklist li {
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #10a37f;
        }

        .checklist li:before {
            content: "□ ";
            font-weight: bold;
            color: #10a37f;
            margin-right: 10px;
        }

        .time-saved {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin: 40px 0;
            box-shadow: 0 10px 25px rgba(17, 153, 142, 0.3);
        }

        hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 30px 0;
        }

        @media print {
            body {
                padding: 20px;
            }

            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>
    <h1>ChatKit Integration - What Went Wrong & How to Fix It Fast</h1>

    <div class="summary-box">
        <p><strong>Total Issues:</strong> 3 major problems</p>
        <p><strong>Time Lost:</strong> 3 days</p>
        <p><strong>Root Cause:</strong> Missing official documentation + deployment sync issues</p>
    </div>

    <hr>

    <h2>Problem #1: Wrong script.js Deployed (Syntax Error)</h2>

    <div class="problem-section">
        <h3>What Happened</h3>
        <p>Browser showed: <code>Uncaught SyntaxError: Unexpected token 'export'</code></p>

        <h3>Root Cause</h3>
        <p>GitHub had the <strong>server-side code</strong> (<code>api/chat.js</code>) in the <code>script.js</code>
            file instead of browser code. The browser tried to execute <code>module.exports</code> which doesn't exist
            in browsers.</p>
    </div>

    <div class="fix-section">
        <h3>How We Fixed It</h3>
        <ol>
            <li>Verified local <code>script.js</code> was correct</li>
            <li>Checked GitHub - found it had wrong content</li>
            <li>Manually edited <code>script.js</code> on GitHub to replace with correct browser code</li>
            <li>Redeployed</li>
        </ol>
    </div>

    <div class="lesson-section">
        <h3>Lesson Learned</h3>
        <p><strong>Always verify GitHub content matches local files before debugging deployment issues.</strong></p>
        <p>Quick check:</p>
        <pre><code># Compare local vs GitHub
git status
git diff HEAD</code></pre>
    </div>

    <hr>

    <h2>Problem #2: ESM vs CommonJS Compilation Warning</h2>

    <div class="problem-section">
        <h3>What Happened</h3>
        <p>Build logs showed: <code>Warning: Node.js functions are compiled from ESM to CommonJS</code></p>

        <h3>Root Cause</h3>
        <p>Used <code>export default</code> in serverless function, but Vercel prefers CommonJS
            (<code>module.exports</code>) for serverless functions.</p>
    </div>

    <div class="fix-section">
        <h3>How We Fixed It</h3>
        <p>Changed <code>api/chat.js</code> from:</p>
        <pre><code>export default async function handler(req, res) {</code></pre>
        <p>To:</p>
        <pre><code>module.exports = async function handler(req, res) {</code></pre>
    </div>

    <div class="lesson-section">
        <h3>Lesson Learned</h3>
        <p><strong>For Vercel serverless functions, use CommonJS syntax (<code>module.exports</code>) to avoid
                compilation issues.</strong></p>
    </div>

    <hr>

    <h2>Problem #3: Missing Required API Parameter</h2>

    <div class="problem-section">
        <h3>What Happened</h3>
        <p>Runtime logs showed:</p>
        <pre><code>OpenAI API failed with status 400
Missing required parameter: 'user'</code></pre>

        <h3>Root Cause</h3>
        <p>The API request was missing the <code>user</code> parameter that OpenAI's ChatKit API requires.</p>

        <h3>Original (Wrong) Request:</h3>
        <pre><code>body: JSON.stringify({
    workflow: { id: workflowId }
})</code></pre>
    </div>

    <div class="fix-section">
        <h3>Fixed Request:</h3>
        <pre><code>body: JSON.stringify({
    workflow: { id: workflowId },
    user: "anonymous-user"  // ← This was missing!
})</code></pre>
    </div>

    <div class="lesson-section">
        <h3>Lesson Learned</h3>
        <p><strong>Always reference the OFFICIAL documentation for the exact API format.</strong> Don't guess based on
            SDK examples.</p>
        <p>Where to find it: <code>https://platform.openai.com/docs/guides/chatkit</code></p>
    </div>

    <hr>

    <h2>How to Debug This Type of Issue in 30 Minutes (Not 3 Days)</h2>

    <h3>Step 1: Verify Local vs Deployed Files (5 min)</h3>
    <pre><code># Check what's committed
git log --oneline -5

# Verify GitHub matches local
# Go to GitHub repo, click files, compare line-by-line</code></pre>

    <h3>Step 2: Check Build Logs (5 min)</h3>
    <ul>
        <li>Vercel Dashboard → Deployments → Latest → Build Logs</li>
        <li>Look for: <code>Detected API Routes</code>, ESM warnings, error messages</li>
    </ul>

    <h3>Step 3: Check Runtime Logs (5 min)</h3>
    <ul>
        <li>Vercel Dashboard → Logs (Runtime, not Build)</li>
        <li>Trigger the feature (load page, click button)</li>
        <li>See EXACT error from OpenAI API</li>
    </ul>

    <h3>Step 4: Check Browser Console (5 min)</h3>
    <ul>
        <li>Open DevTools → Console</li>
        <li>Look for first error (ignore subsequent cascade errors)</li>
        <li>Check Network tab → Failed requests → Response body</li>
    </ul>

    <h3>Step 5: Verify API Format Against Official Docs (10 min)</h3>
    <ul>
        <li>Go to official documentation</li>
        <li>Compare request body format EXACTLY</li>
        <li>Use <code>curl</code> to test API directly if needed</li>
    </ul>

    <hr>

    <h2>Prevention Checklist for Next Project</h2>

    <ul class="checklist">
        <li><strong>Read official docs FIRST</strong> before writing code</li>
        <li><strong>Use starter repo</strong> if available (OpenAI has one:
            https://github.com/openai/openai-chatkit-starter-app)</li>
        <li><strong>Verify deployment:</strong> Check GitHub after every <code>git push</code></li>
        <li><strong>Test incrementally:</strong> Deploy after each small change, don't batch changes</li>
        <li><strong>Check all 3 logs:</strong> Build logs, Runtime logs, Browser console</li>
        <li><strong>Use TypeScript:</strong> Catches type errors before deployment</li>
    </ul>

    <hr>

    <h2>Key Files Reference</h2>

    <h3>Working Files (Local)</h3>
    <ul>
        <li><code>api/chat.js</code> - Serverless function (CommonJS)</li>
        <li><code>script.js</code> - Browser JavaScript</li>
        <li><code>index.html</code> - Chat widget container</li>
        <li><code>package.json</code> - No dependencies needed (using native fetch)</li>
    </ul>

    <h3>Environment Variables (Vercel Dashboard)</h3>
    <ul>
        <li><code>OPENAI_API_KEY</code> - Your OpenAI secret key</li>
        <li><code>WORKFLOW_ID</code> - Your ChatKit workflow ID</li>
    </ul>

    <h3>Essential Headers for ChatKit API</h3>
    <pre><code>headers: {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${apiKey}`,
    "OpenAI-Beta": "chatkit_beta=v1"  // ← Critical!
}</code></pre>

    <hr>

    <h2>If It Breaks Again</h2>

    <ol>
        <li><strong>Check Runtime Logs first</strong> - they tell you the exact error</li>
        <li><strong>Compare against official docs</strong> - don't rely on memory</li>
        <li><strong>Test API with <code>curl</code></strong> - eliminates frontend as variable</li>
        <li><strong>Ask for help with LOGS</strong> - not just "it doesn't work"</li>
    </ol>

    <div class="time-saved">
        ✅ Time saved: 2 days 23.5 hours
    </div>

    <p class="no-print" style="text-align: center; margin-top: 40px; color: #666; font-size: 14px;">
        <strong>To save as PDF:</strong> Press Ctrl+P (Windows) or Cmd+P (Mac) and select "Save as PDF"
    </p>

</body>

</html>